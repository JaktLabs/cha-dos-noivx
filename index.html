<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ch√° de Casa Nova ‚Äî Adryel & Ketllen</title>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f7f7f7;
      color: #333;
      padding: 20px;
      text-align: center;
    }

    h1 { color: #2c6e49; }

    .box {
      max-width: 500px;
      margin: 40px auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    textarea { resize: vertical; }

    button {
      background-color: #2c6e49;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      margin-top: 15px;
      font-size: 15px;
    }

    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      max-width: 700px;
      margin: 30px auto;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #2c6e49;
      color: white;
    }

    tr:hover { background-color: #f1f1f1; }

    a {
      color: #2c6e49;
      text-decoration: none;
      font-weight: 500;
    }

    .hidden { display: none; }

    .footer {
      margin-top: 40px;
      font-size: 0.9em;
      color: #777;
    }
  </style>
</head>

<body>

<!-- TELA 1 - IDENTIFICA√á√ÉO -->
<div id="identificacao" class="box">
  <h1>Bem-vindo üíö</h1>
  <p>Informe seu primeiro e √∫ltimo nome</p>

  <input type="text" id="nomeBusca" placeholder="Ex: Jo√£o Silva" required />
  <button onclick="verificarConvidado()">Continuar</button>

  <p id="msgBusca"></p>
</div>

<!-- CONFIRMA√á√ÉO DE PRESEN√áA -->
<div id="confirmacao" class="box hidden">
  <h1>Confirma√ß√£o de Presen√ßa üíö</h1>
  <p>Ficaremos muito felizes com a sua presen√ßa!</p>

  <form onsubmit="confirmarPresenca(event)">
    <input type="text" id="nome" readonly />
    <input type="number" id="qtd" min="1" value="1" required />
    <textarea id="obs" placeholder="Observa√ß√µes (opcional)"></textarea>
    <button type="submit">Confirmar presen√ßa</button>
  </form>

  <p id="mensagem-status" style="display:none; color: green; margin-top: 12px;"></p>
</div>

<!-- LISTA DE PRESENTES -->
<div id="presentes" class="hidden">
  <h1>Lista de Presentes ‚Äî Ch√° de Casa Nova</h1>
  <p>Escolha um presente e nos ajude a montar nosso lar üè°</p>

  <table id="listaPresentes">
    <thead>
      <tr>
        <th>Presente</th>
        <th>Status</th>
        <th>Sugest√£o</th>
        <th>A√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4">Carregando...</td></tr>
    </tbody>
  </table>
</div>

<div class="footer">Com carinho, Adryel e Ketllen üíç</div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbxIae2rzpF79hJRLNVVlZFxNRLwiPARYqUryS8J-GMGg3YvpULq285BbY7_k9FkxqMy/exec";

// JSONP
function jsonpRequest(url, cbName) {
  return new Promise(resolve => {
    window[cbName] = data => {
      resolve(data);
      delete window[cbName];
    };
    const s = document.createElement("script");
    s.src = url + "&callback=" + cbName;
    document.body.appendChild(s);
  });
}

// TELA 1
async function verificarConvidado() {
  const nome = document.getElementById("nomeBusca").value.trim();
  const msg = document.getElementById("msgBusca");

  if (!nome) return;

  msg.textContent = "Verificando...";

  const r = await jsonpRequest(
    `${API_BASE}?action=verificar&nome=${encodeURIComponent(nome)}`,
    "cbVer_" + Date.now()
  );

  if (r.encontrado && r.confirmado) {
    abrirPresentes();
  } else {
    document.getElementById("identificacao").classList.add("hidden");
    document.getElementById("confirmacao").classList.remove("hidden");
    document.getElementById("nome").value = nome;
  }
}

// CONFIRMAR PRESEN√áA
async function confirmarPresenca(e) {
  e.preventDefault();

  const msg = document.getElementById("mensagem-status");
  const btn = e.target.querySelector("button");

  btn.disabled = true;
  msg.style.display = "block";
  msg.textContent = "Confirmando... ‚è≥";

  const nome = document.getElementById("nome").value;
  const qtd = document.getElementById("qtd").value;
  const obs = document.getElementById("obs").value;

  const r = await jsonpRequest(
    `${API_BASE}?action=confirmar&nome=${encodeURIComponent(nome)}&qtd=${qtd}&obs=${encodeURIComponent(obs)}`,
    "cbConf_" + Date.now()
  );

  if (r.status === "success") {
    msg.textContent = "Presen√ßa confirmada com sucesso! üíö";
    setTimeout(abrirPresentes, 900);
  } else {
    msg.textContent = "Erro ao confirmar.";
    btn.disabled = false;
  }
}

// PRESENTES
function abrirPresentes() {
  document.getElementById("identificacao").classList.add("hidden");
  document.getElementById("confirmacao").classList.add("hidden");
  document.getElementById("presentes").classList.remove("hidden");
  carregarPresentes();
}

async function carregarPresentes() {
  const data = await jsonpRequest(
    `${API_BASE}?action=list`,
    "cbList_" + Date.now()
  );
  const tbody = document.querySelector("#listaPresentes tbody");
  tbody.innerHTML = "";

  data.forEach(item => {
    const tr = document.createElement("tr");
    const status = (item.Status || "").toLowerCase();

    tr.innerHTML = `
      <td>${item.Presente}</td>
      <td style="color:${status === "reservado" ? "red" : "green"}">
        ${status || "dispon√≠vel"}
      </td>
      <td>${item.Link ? `<a href="${item.Link}" target="_blank">Ver sugest√£o</a>` : "-"}</td>
      <td>
        ${status === "reservado"
          ? "‚Äî"
          : `<button onclick="reservarPresente('${item.Presente}')">Reservar</button>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function reservarPresente(presente) {
  if (!confirm("Deseja reservar este presente?")) return;

  await jsonpRequest(
    `${API_BASE}?action=reserve&presente=${encodeURIComponent(presente)}`,
    "cbRes_" + Date.now()
  );

  carregarPresentes();
}
</script>

</body>
</html>
